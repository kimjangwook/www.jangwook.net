---
title: ç”¨Vertex AI Searchå®ç°ç«™å†…æœç´¢ï¼šCloud Functionsä¸è‡ªåŠ¨åŒ–éƒ¨ç½²
description: >-
  ä»‹ç»å¦‚ä½•åˆ©ç”¨Google Vertex AI Searchåœ¨ç½‘ç«™ä¸Šå®ç°AIæœç´¢åŠŸèƒ½ã€‚ä»Cloud Functions
  APIæœåŠ¡å™¨æ„å»ºåˆ°Shellè„šæœ¬è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼Œé€æ­¥è¯¦ç»†è®²è§£ã€‚
pubDate: '2025-11-30'
heroImage: ../../../assets/blog/vertex-ai-search-site-implementation-hero.jpg
tags:
  - vertex-ai
  - google-cloud
  - cloud-functions
  - search
relatedPosts:
  - slug: e2e-page-test-automation-claude-code
    score: 0.94
    reason:
      ko: 'ìë™í™”, ì›¹ ê°œë°œ, AI/ML, DevOps, ì•„í‚¤í…ì²˜ ë¶„ì•¼ì—ì„œ ìœ ì‚¬í•œ ì£¼ì œë¥¼ ë‹¤ë£¨ë©° ë¹„ìŠ·í•œ ë‚œì´ë„ì…ë‹ˆë‹¤.'
      ja: è‡ªå‹•åŒ–ã€Webé–‹ç™ºã€AI/MLã€DevOpsã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åˆ†é‡ã§é¡ä¼¼ã—ãŸãƒˆãƒ”ãƒƒã‚¯ã‚’æ‰±ã„ã€åŒç¨‹åº¦ã®é›£æ˜“åº¦ã§ã™ã€‚
      en: >-
        Covers similar topics in automation, web development, AI/ML, DevOps,
        architecture with comparable difficulty.
      zh: åœ¨è‡ªåŠ¨åŒ–ã€Webå¼€å‘ã€AI/MLã€DevOpsã€æ¶æ„é¢†åŸŸæ¶µç›–ç±»ä¼¼ä¸»é¢˜ï¼Œéš¾åº¦ç›¸å½“ã€‚
  - slug: adding-chinese-support
    score: 0.94
    reason:
      ko: 'ìë™í™”, ì›¹ ê°œë°œ, AI/ML, DevOps, ì•„í‚¤í…ì²˜ ë¶„ì•¼ì—ì„œ ìœ ì‚¬í•œ ì£¼ì œë¥¼ ë‹¤ë£¨ë©° ë¹„ìŠ·í•œ ë‚œì´ë„ì…ë‹ˆë‹¤.'
      ja: è‡ªå‹•åŒ–ã€Webé–‹ç™ºã€AI/MLã€DevOpsã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åˆ†é‡ã§é¡ä¼¼ã—ãŸãƒˆãƒ”ãƒƒã‚¯ã‚’æ‰±ã„ã€åŒç¨‹åº¦ã®é›£æ˜“åº¦ã§ã™ã€‚
      en: >-
        Covers similar topics in automation, web development, AI/ML, DevOps,
        architecture with comparable difficulty.
      zh: åœ¨è‡ªåŠ¨åŒ–ã€Webå¼€å‘ã€AI/MLã€DevOpsã€æ¶æ„é¢†åŸŸæ¶µç›–ç±»ä¼¼ä¸»é¢˜ï¼Œéš¾åº¦ç›¸å½“ã€‚
  - slug: n8n-rss-automation
    score: 0.94
    reason:
      ko: 'ìë™í™”, ì›¹ ê°œë°œ, AI/ML, DevOps, ì•„í‚¤í…ì²˜ ë¶„ì•¼ì—ì„œ ìœ ì‚¬í•œ ì£¼ì œë¥¼ ë‹¤ë£¨ë©° ë¹„ìŠ·í•œ ë‚œì´ë„ì…ë‹ˆë‹¤.'
      ja: è‡ªå‹•åŒ–ã€Webé–‹ç™ºã€AI/MLã€DevOpsã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åˆ†é‡ã§é¡ä¼¼ã—ãŸãƒˆãƒ”ãƒƒã‚¯ã‚’æ‰±ã„ã€åŒç¨‹åº¦ã®é›£æ˜“åº¦ã§ã™ã€‚
      en: >-
        Covers similar topics in automation, web development, AI/ML, DevOps,
        architecture with comparable difficulty.
      zh: åœ¨è‡ªåŠ¨åŒ–ã€Webå¼€å‘ã€AI/MLã€DevOpsã€æ¶æ„é¢†åŸŸæ¶µç›–ç±»ä¼¼ä¸»é¢˜ï¼Œéš¾åº¦ç›¸å½“ã€‚
  - slug: playwright-ai-testing
    score: 0.94
    reason:
      ko: 'ìë™í™”, ì›¹ ê°œë°œ, AI/ML, DevOps, ì•„í‚¤í…ì²˜ ë¶„ì•¼ì—ì„œ ìœ ì‚¬í•œ ì£¼ì œë¥¼ ë‹¤ë£¨ë©° ë¹„ìŠ·í•œ ë‚œì´ë„ì…ë‹ˆë‹¤.'
      ja: è‡ªå‹•åŒ–ã€Webé–‹ç™ºã€AI/MLã€DevOpsã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åˆ†é‡ã§é¡ä¼¼ã—ãŸãƒˆãƒ”ãƒƒã‚¯ã‚’æ‰±ã„ã€åŒç¨‹åº¦ã®é›£æ˜“åº¦ã§ã™ã€‚
      en: >-
        Covers similar topics in automation, web development, AI/ML, DevOps,
        architecture with comparable difficulty.
      zh: åœ¨è‡ªåŠ¨åŒ–ã€Webå¼€å‘ã€AI/MLã€DevOpsã€æ¶æ„é¢†åŸŸæ¶µç›–ç±»ä¼¼ä¸»é¢˜ï¼Œéš¾åº¦ç›¸å½“ã€‚
  - slug: notion-backlog-slack-claude-project-management
    score: 0.94
    reason:
      ko: 'ìë™í™”, AI/ML, DevOps, ì•„í‚¤í…ì²˜ ë¶„ì•¼ì—ì„œ ìœ ì‚¬í•œ ì£¼ì œë¥¼ ë‹¤ë£¨ë©° ë¹„ìŠ·í•œ ë‚œì´ë„ì…ë‹ˆë‹¤.'
      ja: è‡ªå‹•åŒ–ã€AI/MLã€DevOpsã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åˆ†é‡ã§é¡ä¼¼ã—ãŸãƒˆãƒ”ãƒƒã‚¯ã‚’æ‰±ã„ã€åŒç¨‹åº¦ã®é›£æ˜“åº¦ã§ã™ã€‚
      en: >-
        Covers similar topics in automation, AI/ML, DevOps, architecture with
        comparable difficulty.
      zh: åœ¨è‡ªåŠ¨åŒ–ã€AI/MLã€DevOpsã€æ¶æ„é¢†åŸŸæ¶µç›–ç±»ä¼¼ä¸»é¢˜ï¼Œéš¾åº¦ç›¸å½“ã€‚
---

## å¼•è¨€

ç°ä»£ç½‘ç«™æœç´¢ä¸å†å±€é™äºç®€å•çš„å…³é”®è¯åŒ¹é…ã€‚ç”¨æˆ·æœŸå¾…çš„æ˜¯èƒ½å¤Ÿç†è§£ä¸Šä¸‹æ–‡ã€æä¾›æ™ºèƒ½æ‘˜è¦çš„æœç´¢ä½“éªŒã€‚Google Cloudçš„<strong>Vertex AI Search</strong>æ­£æ˜¯ä¸ºæ­¤è€Œç”Ÿâ€”â€”å®ƒç»“åˆäº†ä¼ ç»Ÿå…¨æ–‡æœç´¢å’ŒAIé©±åŠ¨çš„è¯­ä¹‰ç†è§£ï¼Œèƒ½å¤Ÿæä¾›ç²¾å‡†ä¸”å¯Œæœ‰æ´å¯ŸåŠ›çš„æœç´¢ç»“æœã€‚

æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å¦‚ä½•ï¼š
- ä½¿ç”¨Vertex AI Searchæ„å»ºä¼ä¸šçº§æœç´¢å¼•æ“
- é€šè¿‡Cloud Functionsåˆ›å»ºæœç´¢APIæœåŠ¡å™¨
- åˆ©ç”¨Shellè„šæœ¬å®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²
- å°†AIæœç´¢åŠŸèƒ½é›†æˆåˆ°å®é™…ç½‘ç«™

æ— è®ºä½ æ˜¯æƒ³ä¸ºåšå®¢æ·»åŠ æ™ºèƒ½æœç´¢ï¼Œè¿˜æ˜¯ä¸ºä¼ä¸šçŸ¥è¯†åº“æ„å»ºæœç´¢ç³»ç»Ÿï¼Œæœ¬æ–‡éƒ½å°†ä¸ºä½ æä¾›å®Œæ•´çš„å®æ–½æ–¹æ¡ˆã€‚

## Vertex AI Search çš„ç‰¹ç‚¹

### ä¸ä¼ ç»Ÿæœç´¢çš„åŒºåˆ«

Vertex AI Searchä¸ä»…ä»…æ˜¯ä¸€ä¸ªæœç´¢å¼•æ“ï¼Œå®ƒæ˜¯ä¸€ä¸ªå®Œæ•´çš„AIæœç´¢å¹³å°ï¼š

| ç‰¹æ€§ | ä¼ ç»Ÿæœç´¢ | Vertex AI Search |
|------|---------|------------------|
| æœç´¢æ–¹å¼ | å…³é”®è¯åŒ¹é… | è¯­ä¹‰ç†è§£ + å…³é”®è¯ |
| ç»“æœå‘ˆç° | é“¾æ¥åˆ—è¡¨ | AIç”Ÿæˆæ‘˜è¦ + é“¾æ¥ |
| æ•°æ®æº | å•ä¸€æ•°æ®åº“ | å¤šæºæ•´åˆï¼ˆç½‘ç«™ã€æ–‡æ¡£ç­‰ï¼‰ |
| ä¸ªæ€§åŒ– | åŸºç¡€æ’åº | AIé©±åŠ¨çš„ç›¸å…³æ€§æ’åº |
| å¼€å‘æˆæœ¬ | é«˜ï¼ˆéœ€è‡ªå»ºç´¢å¼•ï¼‰ | ä½ï¼ˆæ‰˜ç®¡æœåŠ¡ï¼‰ |

### æ¶æ„æ¦‚è§ˆ

æ•´ä½“ç³»ç»Ÿé‡‡ç”¨ä¸‰å±‚æ¶æ„ï¼š

```mermaid
graph TB
    subgraph ç”¨æˆ·ç•Œé¢
        A[ç½‘ç«™å‰ç«¯]
        B[æœç´¢æ¡†]
    end

    subgraph Cloud Functions
        C[æœç´¢API]
        D[CORSå¤„ç†]
        E[é”™è¯¯å¤„ç†]
    end

    subgraph Vertex AI
        F[Discovery Engine]
        G[æœç´¢ç´¢å¼•]
        H[AIæ‘˜è¦ç”Ÿæˆ]
    end

    A --> B
    B --> C
    C --> D
    D --> F
    F --> G
    F --> H
    H --> C
    C --> A
```

æ ¸å¿ƒæµç¨‹ï¼š
1. ç”¨æˆ·åœ¨ç½‘ç«™è¾“å…¥æœç´¢æŸ¥è¯¢
2. å‰ç«¯è°ƒç”¨Cloud Functions API
3. Cloud Functionsè½¬å‘è¯·æ±‚åˆ°Vertex AI Search
4. AIå¼•æ“å¤„ç†æŸ¥è¯¢ã€ç”Ÿæˆæ‘˜è¦
5. ç»“æœè¿”å›ç»™ç”¨æˆ·

## å‰ç½®å‡†å¤‡

### Google Cloudé¡¹ç›®é…ç½®

<strong>æ­¥éª¤1ï¼šåˆ›å»ºæˆ–é€‰æ‹©GCPé¡¹ç›®</strong>

```bash
# åˆ›å»ºæ–°é¡¹ç›®
gcloud projects create my-search-project \
  --name="AI Search Project"

# è®¾ç½®å½“å‰é¡¹ç›®
gcloud config set project my-search-project
```

<strong>æ­¥éª¤2ï¼šå¯ç”¨å¿…éœ€çš„API</strong>

```bash
# å¯ç”¨Vertex AI Search API
gcloud services enable discoveryengine.googleapis.com

# å¯ç”¨Cloud Functions API
gcloud services enable cloudfunctions.googleapis.com

# å¯ç”¨Cloud Build APIï¼ˆç”¨äºéƒ¨ç½²ï¼‰
gcloud services enable cloudbuild.googleapis.com
```

### åˆ›å»ºVertex AI Searchå¼•æ“

<strong>ä½¿ç”¨Agent Builderåˆ›å»ºæœç´¢åº”ç”¨</strong>ï¼š

1. è®¿é—®[Google Cloud Console](https://console.cloud.google.com/)
2. å¯¼èˆªåˆ° **Vertex AI** â†’ **Agent Builder**
3. ç‚¹å‡» **åˆ›å»ºåº”ç”¨** â†’ é€‰æ‹© **æœç´¢**
4. é…ç½®æ•°æ®æºï¼š
   - **ç½‘ç«™çˆ¬å–**ï¼šè¾“å…¥ä½ çš„ç½‘ç«™URL
   - **æ–‡æ¡£ä¸Šä¼ **ï¼šä¸Šä¼ PDFã€HTMLç­‰æ–‡ä»¶
   - **BigQuery**ï¼šè¿æ¥æ•°æ®åº“

5. é…ç½®æœç´¢é€‰é¡¹ï¼š
   - å¯ç”¨ **ç”Ÿæˆå¼æ‘˜è¦**ï¼ˆAI Summaryï¼‰
   - è®¾ç½® **ç»“æœæ’åºè§„åˆ™**
   - é…ç½® **è¿‡æ»¤å™¨å’Œåˆ»é¢**

6. è®°ä¸‹åˆ›å»ºå®Œæˆåçš„ï¼š
   - **ENGINE_ID**ï¼ˆæœç´¢å¼•æ“IDï¼‰
   - **PROJECT_ID**ï¼ˆé¡¹ç›®IDï¼‰
   - **PROJECT_NUMBER**ï¼ˆé¡¹ç›®ç¼–å·ï¼‰

## Cloud Functions APIæœåŠ¡å™¨å®ç°

### æ ¸å¿ƒä»£ç è¯´æ˜ï¼ˆindex.jsï¼‰

åˆ›å»º `index.js` æ–‡ä»¶ï¼Œå®ç°æœç´¢APIç«¯ç‚¹ï¼š

```javascript
// å¯¼å…¥Google Discovery Engineå®¢æˆ·ç«¯
const { SearchServiceClient } = require('@google-cloud/discoveryengine').v1alpha;

// ä»ç¯å¢ƒå˜é‡è·å–é…ç½®
const PROJECT_ID = process.env.PROJECT_ID;
const ENGINE_ID = process.env.ENGINE_ID;
const LOCATION = process.env.LOCATION || 'global';
const ALLOWED_DOMAINS = process.env.ALLOWED_DOMAINS?.split(',') || [];

/**
 * HTTP Cloud Function - æœç´¢ç«¯ç‚¹
 *
 * @param {Object} req - Expressè¯·æ±‚å¯¹è±¡
 * @param {Object} res - Expresså“åº”å¯¹è±¡
 */
exports.search = async (req, res) => {
  // CORSè®¾ç½® - åªå…è®¸ç‰¹å®šåŸŸåè®¿é—®
  const origin = req.headers.origin;
  if (ALLOWED_DOMAINS.includes(origin)) {
    res.set('Access-Control-Allow-Origin', origin);
  }

  res.set('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.set('Access-Control-Allow-Headers', 'Content-Type');

  // å¤„ç†é¢„æ£€è¯·æ±‚
  if (req.method === 'OPTIONS') {
    res.status(204).send('');
    return;
  }

  try {
    // 1. éªŒè¯è¯·æ±‚å‚æ•°
    const { query, pageSize = 10 } = req.body;

    if (!query || query.trim() === '') {
      res.status(400).json({
        error: 'Search query is required'
      });
      return;
    }

    // 2. åˆå§‹åŒ–Discovery Engineå®¢æˆ·ç«¯
    const client = new SearchServiceClient();

    // 3. æ„å»ºæœç´¢è¯·æ±‚
    const servingConfig = `projects/${PROJECT_ID}/locations/${LOCATION}/collections/default_collection/engines/${ENGINE_ID}/servingConfigs/default_config`;

    const request = {
      servingConfig,
      query: query.trim(),
      pageSize: Math.min(pageSize, 50), // é™åˆ¶æœ€å¤§ç»“æœæ•°
      queryExpansionSpec: { condition: 'AUTO' },
      spellCorrectionSpec: { mode: 'AUTO' },

      // å¯ç”¨AIæ‘˜è¦ç”Ÿæˆ
      contentSearchSpec: {
        summarySpec: {
          summaryResultCount: 5,
          includeCitations: true,
          ignoreAdversarialQuery: true,
          ignoreNonSummarySeekingQuery: true,
        },
      },
    };

    // 4. æ‰§è¡Œæœç´¢
    const [response] = await client.search(request);

    // 5. æ•´ç†æœç´¢ç»“æœ
    const results = response.results?.map(result => {
      const doc = result.document;
      const structData = doc.structData || {};

      return {
        id: doc.id,
        title: structData.title || 'æ— æ ‡é¢˜',
        link: structData.link || doc.name,
        snippet: structData.snippet || structData.description || '',
        // ç¼©ç•¥å›¾ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        thumbnail: structData.thumbnailUrl || structData.image_url || null,
        // å‘å¸ƒæ—¥æœŸ
        publishDate: structData.pubDate || structData.publishedDate || null,
      };
    }) || [];

    // 6. æå–AIæ‘˜è¦
    const summary = response.summary?.summaryText || null;
    const citations = response.summary?.summaryWithMetadata?.references || [];

    // 7. è¿”å›ç»“æœ
    res.json({
      query,
      totalResults: results.length,
      results,
      summary: summary ? {
        text: summary,
        citations: citations.map(ref => ({
          title: ref.title,
          url: ref.uri,
        })),
      } : null,
    });

  } catch (error) {
    console.error('Search error:', error);

    // é…é¢è¶…é™æ—¶çš„é™çº§å¤„ç†
    if (error.code === 8 || error.code === 429) {
      res.status(503).json({
        error: 'Search quota exceeded. Please try again later.',
        retryAfter: 60,
      });
      return;
    }

    // å…¶ä»–é”™è¯¯
    res.status(500).json({
      error: 'Internal server error',
      message: error.message,
    });
  }
};
```

<strong>ä»£ç äº®ç‚¹</strong>ï¼š

1. **ç¯å¢ƒå˜é‡é©±åŠ¨é…ç½®**ï¼šæ‰€æœ‰æ•æ„Ÿä¿¡æ¯é€šè¿‡ç¯å¢ƒå˜é‡ç®¡ç†
2. **CORSå®‰å…¨æ§åˆ¶**ï¼šåªå…è®¸ç™½åå•åŸŸåè®¿é—®
3. **æ™ºèƒ½é™çº§**ï¼šé…é¢è¶…é™æ—¶è¿”å›å‹å¥½é”™è¯¯
4. **ç»“æœæ ‡å‡†åŒ–**ï¼šç»Ÿä¸€çš„JSONå“åº”æ ¼å¼
5. **AIæ‘˜è¦é›†æˆ**ï¼šè‡ªåŠ¨ç”Ÿæˆæœç´¢ç»“æœæ‘˜è¦

### ä¾èµ–ç®¡ç†ï¼ˆpackage.jsonï¼‰

åˆ›å»º `package.json` æ–‡ä»¶ï¼š

```json
{
  "name": "vertex-ai-search-function",
  "version": "1.0.0",
  "description": "Vertex AI Search API for website",
  "main": "index.js",
  "engines": {
    "node": "20"
  },
  "dependencies": {
    "@google-cloud/discoveryengine": "^1.0.0",
    "@google-cloud/functions-framework": "^3.4.0"
  },
  "scripts": {
    "start": "functions-framework --target=search"
  }
}
```

## ç¯å¢ƒå˜é‡é…ç½®

### åˆ›å»º.envæ–‡ä»¶

åˆ›å»º `.env.example` æ¨¡æ¿æ–‡ä»¶ï¼š

```bash
# ============================================
# Vertex AI Search Configuration
# ============================================

# å¿…éœ€é…ç½®
PROJECT_ID=your-project-id              # GCPé¡¹ç›®ID
PROJECT_NUMBER=123456789                # GCPé¡¹ç›®ç¼–å·
ENGINE_ID=your-engine-id_1234567890     # æœç´¢å¼•æ“ID

# CORSè®¾ç½®ï¼ˆå¤šä¸ªåŸŸåç”¨é€—å·åˆ†éš”ï¼‰
ALLOWED_DOMAINS=https://example.com,https://www.example.com

# ============================================
# Deployment Configuration
# ============================================

# Cloud Functionséƒ¨ç½²åŒºåŸŸ
REGION=asia-northeast1                  # ä¸œäº¬
# REGION=us-central1                    # çˆ±è·åï¼ˆå¤‡é€‰ï¼‰

# èµ„æºé…ç½®
MEMORY=256MB                            # å†…å­˜åˆ†é…
TIMEOUT=60s                             # è¶…æ—¶æ—¶é—´
MIN_INSTANCES=0                         # æœ€å°å®ä¾‹æ•°ï¼ˆå†·å¯åŠ¨ä¼˜åŒ–è®¾ä¸º1ï¼‰
MAX_INSTANCES=10                        # æœ€å¤§å®ä¾‹æ•°

# ============================================
# Vertex AI Search Settings
# ============================================

LOCATION=global                         # æœç´¢å¼•æ“ä½ç½®
DEFAULT_PAGE_SIZE=10                    # é»˜è®¤ç»“æœæ•°
MAX_PAGE_SIZE=50                        # æœ€å¤§ç»“æœæ•°
```

<strong>é…ç½®è¯´æ˜</strong>ï¼š

- **PROJECT_ID**: åœ¨GCPæ§åˆ¶å°é¡¶éƒ¨æŸ¥çœ‹
- **PROJECT_NUMBER**: åœ¨é¡¹ç›®è®¾ç½®ä¸­çš„"é¡¹ç›®ç¼–å·"
- **ENGINE_ID**: åˆ›å»ºæœç´¢å¼•æ“ååœ¨Agent Builderä¸­æŸ¥çœ‹
- **ALLOWED_DOMAINS**: é™åˆ¶å“ªäº›ç½‘ç«™å¯ä»¥è°ƒç”¨APIï¼ˆå®‰å…¨æ€§ï¼‰
- **REGION**: é€‰æ‹©ç¦»ç”¨æˆ·æœ€è¿‘çš„åŒºåŸŸä»¥é™ä½å»¶è¿Ÿ

## è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬ï¼ˆdeploy.shï¼‰

è¿™æ˜¯æœ¬æ–‡çš„<strong>æ ¸å¿ƒäº®ç‚¹</strong>â€”â€”ä¸€ä¸ªå…¨åŠŸèƒ½çš„éƒ¨ç½²è„šæœ¬ï¼Œèƒ½å¤Ÿè‡ªåŠ¨åŒ–æ•´ä¸ªéƒ¨ç½²æµç¨‹ã€‚

### è„šæœ¬ä¸»è¦åŠŸèƒ½

åˆ›å»º `deploy.sh` æ–‡ä»¶ï¼š

```bash
#!/bin/bash

# ============================================
# Vertex AI Search Cloud Functions éƒ¨ç½²è„šæœ¬
# ============================================
#
# åŠŸèƒ½ï¼š
# - è‡ªåŠ¨è¯»å–.envé…ç½®
# - æ£€æŸ¥å¹¶åˆ‡æ¢GCPé¡¹ç›®
# - å¯ç”¨å¿…éœ€çš„API
# - éƒ¨ç½²Cloud Functions
# - ç”Ÿæˆæµ‹è¯•HTML
#
# ä½¿ç”¨æ–¹æ³•ï¼š
#   ./deploy.sh                    # ä½¿ç”¨.envæ–‡ä»¶
#   ./deploy.sh --env-file .env.prod  # ä½¿ç”¨æŒ‡å®šç¯å¢ƒæ–‡ä»¶
#   ./deploy.sh --dry-run          # ä»…æ˜¾ç¤ºå°†æ‰§è¡Œçš„å‘½ä»¤
# ============================================

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

# é¢œè‰²è¾“å‡ºï¼ˆå¢å¼ºå¯è¯»æ€§ï¼‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# ============================================
# 1. è§£æå‘½ä»¤è¡Œå‚æ•°
# ============================================

ENV_FILE=".env"
DRY_RUN=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --env-file)
            ENV_FILE="$2"
            shift 2
            ;;
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        *)
            log_error "Unknown parameter: $1"
            exit 1
            ;;
    esac
done

# ============================================
# 2. è¯»å–ç¯å¢ƒå˜é‡
# ============================================

log_info "Loading environment from ${ENV_FILE}..."

if [ ! -f "${ENV_FILE}" ]; then
    log_error "Environment file ${ENV_FILE} not found!"
    log_info "Please copy .env.example to ${ENV_FILE} and configure it."
    exit 1
fi

# è¯»å–.envæ–‡ä»¶ï¼ˆå¿½ç•¥æ³¨é‡Šå’Œç©ºè¡Œï¼‰
export $(grep -v '^#' ${ENV_FILE} | grep -v '^$' | xargs)

# éªŒè¯å¿…éœ€å˜é‡
REQUIRED_VARS=("PROJECT_ID" "ENGINE_ID" "REGION")
for var in "${REQUIRED_VARS[@]}"; do
    if [ -z "${!var}" ]; then
        log_error "Required variable ${var} is not set in ${ENV_FILE}"
        exit 1
    fi
done

log_success "Environment loaded successfully"

# ============================================
# 3. GCPé¡¹ç›®æ£€æŸ¥ä¸åˆ‡æ¢
# ============================================

log_info "Checking GCP project..."

CURRENT_PROJECT=$(gcloud config get-value project 2>/dev/null || echo "")

if [ "${CURRENT_PROJECT}" != "${PROJECT_ID}" ]; then
    log_warning "Current project (${CURRENT_PROJECT}) differs from target (${PROJECT_ID})"

    if [ "${DRY_RUN}" = false ]; then
        log_info "Switching to project ${PROJECT_ID}..."
        gcloud config set project ${PROJECT_ID}
        log_success "Switched to project ${PROJECT_ID}"
    fi
else
    log_success "Already using project ${PROJECT_ID}"
fi

# ============================================
# 4. å¯ç”¨å¿…éœ€çš„API
# ============================================

log_info "Enabling required APIs..."

REQUIRED_APIS=(
    "cloudfunctions.googleapis.com"
    "cloudbuild.googleapis.com"
    "discoveryengine.googleapis.com"
    "run.googleapis.com"
)

for api in "${REQUIRED_APIS[@]}"; do
    log_info "Checking ${api}..."

    if [ "${DRY_RUN}" = false ]; then
        gcloud services enable ${api} --quiet
        log_success "Enabled ${api}"
    else
        echo "  Would enable: ${api}"
    fi
done

# ============================================
# 5. éƒ¨ç½²Cloud Functions
# ============================================

log_info "Deploying Cloud Functions..."

FUNCTION_NAME="vertex-ai-search"
ENTRY_POINT="search"

# æ„å»ºgcloudå‘½ä»¤
DEPLOY_CMD="gcloud functions deploy ${FUNCTION_NAME} \\
  --gen2 \\
  --runtime=nodejs20 \\
  --region=${REGION} \\
  --source=. \\
  --entry-point=${ENTRY_POINT} \\
  --trigger-http \\
  --allow-unauthenticated \\
  --memory=${MEMORY:-256MB} \\
  --timeout=${TIMEOUT:-60s} \\
  --min-instances=${MIN_INSTANCES:-0} \\
  --max-instances=${MAX_INSTANCES:-10} \\
  --set-env-vars=\"PROJECT_ID=${PROJECT_ID},ENGINE_ID=${ENGINE_ID},LOCATION=${LOCATION:-global},ALLOWED_DOMAINS=${ALLOWED_DOMAINS}\""

if [ "${DRY_RUN}" = true ]; then
    log_info "Dry run mode - would execute:"
    echo -e "${DEPLOY_CMD}"
else
    log_info "Deploying function (this may take a few minutes)..."
    eval ${DEPLOY_CMD}
    log_success "Function deployed successfully!"
fi

# ============================================
# 6. è·å–å¹¶ä¿å­˜ç«¯ç‚¹URL
# ============================================

if [ "${DRY_RUN}" = false ]; then
    log_info "Retrieving function URL..."

    FUNCTION_URL=$(gcloud functions describe ${FUNCTION_NAME} \
        --region=${REGION} \
        --gen2 \
        --format="value(serviceConfig.uri)")

    if [ -z "${FUNCTION_URL}" ]; then
        log_error "Failed to retrieve function URL"
        exit 1
    fi

    log_success "Function URL: ${FUNCTION_URL}"

    # ä¿å­˜åˆ°æ–‡ä»¶
    echo "${FUNCTION_URL}" > function_url.txt
    log_info "URL saved to function_url.txt"
fi

# ============================================
# 7. ç”Ÿæˆæµ‹è¯•HTML
# ============================================

if [ "${DRY_RUN}" = false ]; then
    log_info "Generating test HTML..."

    cat > test_search.html <<EOF
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vertex AI Search æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }
        input {
            flex: 1;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        button {
            padding: 12px 24px;
            font-size: 16px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        button:hover {
            background: #357ae8;
        }
        .summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #4285f4;
        }
        .result {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        .result h3 {
            margin: 0 0 5px 0;
        }
        .result a {
            color: #4285f4;
            text-decoration: none;
        }
        .result a:hover {
            text-decoration: underline;
        }
        .error {
            color: #d93025;
            padding: 15px;
            background: #fce8e6;
            border-radius: 8px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>ğŸ” Vertex AI Search æµ‹è¯•</h1>

    <div class="search-box">
        <input type="text" id="query" placeholder="è¾“å…¥æœç´¢å…³é”®è¯..." />
        <button onclick="performSearch()">æœç´¢</button>
    </div>

    <div id="results"></div>

    <script>
        const FUNCTION_URL = '${FUNCTION_URL}';

        // å›è½¦é”®æœç´¢
        document.getElementById('query').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performSearch();
        });

        async function performSearch() {
            const query = document.getElementById('query').value.trim();
            const resultsDiv = document.getElementById('results');

            if (!query) {
                resultsDiv.innerHTML = '<p class="error">è¯·è¾“å…¥æœç´¢å…³é”®è¯</p>';
                return;
            }

            resultsDiv.innerHTML = '<p class="loading">æœç´¢ä¸­...</p>';

            try {
                const response = await fetch(FUNCTION_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query, pageSize: 10 }),
                });

                if (!response.ok) {
                    throw new Error(\`HTTP error! status: \${response.status}\`);
                }

                const data = await response.json();
                displayResults(data);

            } catch (error) {
                console.error('Search error:', error);
                resultsDiv.innerHTML = \`<p class="error">æœç´¢å¤±è´¥ï¼š\${error.message}</p>\`;
            }
        }

        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            let html = '';

            // æ˜¾ç¤ºAIæ‘˜è¦
            if (data.summary) {
                html += \`
                    <div class="summary">
                        <strong>AI æ‘˜è¦ï¼š</strong>
                        <p>\${data.summary.text}</p>
                    </div>
                \`;
            }

            // æ˜¾ç¤ºæœç´¢ç»“æœ
            if (data.results && data.results.length > 0) {
                html += \`<p>æ‰¾åˆ° \${data.totalResults} ä¸ªç»“æœ</p>\`;

                data.results.forEach(result => {
                    html += \`
                        <div class="result">
                            <h3><a href="\${result.link}" target="_blank">\${result.title}</a></h3>
                            <p>\${result.snippet}</p>
                        </div>
                    \`;
                });
            } else {
                html += '<p>æœªæ‰¾åˆ°ç›¸å…³ç»“æœ</p>';
            }

            resultsDiv.innerHTML = html;
        }
    </script>
</body>
</html>
EOF

    log_success "Test HTML generated: test_search.html"
    log_info "Open test_search.html in your browser to test the search function"
fi

# ============================================
# 8. éƒ¨ç½²æ‘˜è¦
# ============================================

log_success "=================================================="
log_success "Deployment completed successfully!"
log_success "=================================================="

if [ "${DRY_RUN}" = false ]; then
    echo ""
    log_info "Function Details:"
    echo "  Name:        ${FUNCTION_NAME}"
    echo "  Region:      ${REGION}"
    echo "  URL:         ${FUNCTION_URL}"
    echo ""
    log_info "Next Steps:"
    echo "  1. Open test_search.html to test the search"
    echo "  2. Integrate the API into your website"
    echo "  3. Monitor usage in GCP Console"
fi
```

### è„šæœ¬ä½¿ç”¨æ–¹æ³•

<strong>åŸºæœ¬ä½¿ç”¨</strong>ï¼š

```bash
# 1. èµ‹äºˆæ‰§è¡Œæƒé™
chmod +x deploy.sh

# 2. ä½¿ç”¨é»˜è®¤.envæ–‡ä»¶éƒ¨ç½²
./deploy.sh

# 3. ä½¿ç”¨ç”Ÿäº§ç¯å¢ƒé…ç½®
./deploy.sh --env-file .env.production

# 4. è¯•è¿è¡Œï¼ˆä¸å®é™…éƒ¨ç½²ï¼‰
./deploy.sh --dry-run
```

<strong>å¤šç¯å¢ƒç®¡ç†</strong>ï¼š

```bash
# é¡¹ç›®ç»“æ„
.
â”œâ”€â”€ .env.development    # å¼€å‘ç¯å¢ƒ
â”œâ”€â”€ .env.staging        # æµ‹è¯•ç¯å¢ƒ
â”œâ”€â”€ .env.production     # ç”Ÿäº§ç¯å¢ƒ
â”œâ”€â”€ deploy.sh
â”œâ”€â”€ index.js
â””â”€â”€ package.json

# éƒ¨ç½²åˆ°ä¸åŒç¯å¢ƒ
./deploy.sh --env-file .env.development   # å¼€å‘
./deploy.sh --env-file .env.staging       # æµ‹è¯•
./deploy.sh --env-file .env.production    # ç”Ÿäº§
```

### è„šæœ¬æ ¸å¿ƒäº®ç‚¹

1. **æ™ºèƒ½ç¯å¢ƒç®¡ç†**
   - è‡ªåŠ¨è¯»å–å’ŒéªŒè¯.envæ–‡ä»¶
   - æ”¯æŒå¤šç¯å¢ƒé…ç½®åˆ‡æ¢
   - å¿…éœ€å˜é‡æ£€æŸ¥

2. **å®‰å…¨çš„GCPæ“ä½œ**
   - è‡ªåŠ¨æ£€æŸ¥å½“å‰é¡¹ç›®
   - é¿å…è¯¯æ“ä½œå…¶ä»–é¡¹ç›®
   - å®‰å…¨çš„é¡¹ç›®åˆ‡æ¢

3. **è‡ªåŠ¨åŒ–APIå¯ç”¨**
   - æ£€æµ‹å¹¶å¯ç”¨å¿…éœ€çš„GCP API
   - å¹‚ç­‰æ“ä½œï¼ˆé‡å¤æ‰§è¡Œå®‰å…¨ï¼‰

4. **è¯¦ç»†çš„æ—¥å¿—è¾“å‡º**
   - å½©è‰²æ—¥å¿—å¢å¼ºå¯è¯»æ€§
   - æ¸…æ™°çš„æ“ä½œæ­¥éª¤æç¤º
   - é”™è¯¯æ—¶ç«‹å³åœæ­¢

5. **æµ‹è¯•å·¥å…·ç”Ÿæˆ**
   - è‡ªåŠ¨ç”Ÿæˆæµ‹è¯•HTMLé¡µé¢
   - åŒ…å«å®Œæ•´çš„æœç´¢UI
   - å³å¼€å³ç”¨

## å‰ç«¯é›†æˆ

### åˆ›å»ºæœç´¢ç»„ä»¶

åœ¨Astroç½‘ç«™ä¸­é›†æˆæœç´¢åŠŸèƒ½ï¼š

```astro
---
// src/components/VertexAISearch.astro
const SEARCH_API_URL = import.meta.env.PUBLIC_SEARCH_API_URL;
---

<div class="search-container">
  <input
    type="search"
    id="ai-search-input"
    placeholder="åœ¨ç«™å†…æœç´¢..."
    aria-label="ç«™å†…æœç´¢"
  />
  <div id="search-results"></div>
</div>

<script define:vars={{ SEARCH_API_URL }}>
  const searchInput = document.getElementById('ai-search-input');
  const resultsDiv = document.getElementById('search-results');

  let searchTimeout;

  // é˜²æŠ–æœç´¢ï¼ˆé¿å…é¢‘ç¹è¯·æ±‚ï¼‰
  searchInput.addEventListener('input', (e) => {
    clearTimeout(searchTimeout);

    const query = e.target.value.trim();

    if (query.length < 2) {
      resultsDiv.innerHTML = '';
      return;
    }

    searchTimeout = setTimeout(() => {
      performSearch(query);
    }, 300); // 300mså»¶è¿Ÿ
  });

  async function performSearch(query) {
    resultsDiv.innerHTML = '<div class="loading">æœç´¢ä¸­...</div>';

    try {
      const response = await fetch(SEARCH_API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          query,
          pageSize: 10
        }),
      });

      if (!response.ok) {
        throw new Error(`æœç´¢å¤±è´¥ï¼š${response.status}`);
      }

      const data = await response.json();
      displayResults(data);

    } catch (error) {
      console.error('Search error:', error);
      resultsDiv.innerHTML = `
        <div class="error">
          æœç´¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•
        </div>
      `;
    }
  }

  function displayResults(data) {
    if (!data.results || data.results.length === 0) {
      resultsDiv.innerHTML = '<div class="no-results">æœªæ‰¾åˆ°ç›¸å…³ç»“æœ</div>';
      return;
    }

    let html = '';

    // AIæ‘˜è¦ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if (data.summary && data.summary.text) {
      html += `
        <div class="ai-summary">
          <h3>ğŸ¤– AI æ‘˜è¦</h3>
          <p>${data.summary.text}</p>
        </div>
      `;
    }

    // æœç´¢ç»“æœ
    html += '<div class="search-results-list">';

    data.results.forEach(result => {
      html += `
        <article class="search-result-item">
          <h4>
            <a href="${result.link}">${result.title}</a>
          </h4>
          ${result.snippet ? `<p>${result.snippet}</p>` : ''}
          ${result.publishDate ? `
            <time>${new Date(result.publishDate).toLocaleDateString('zh-CN')}</time>
          ` : ''}
        </article>
      `;
    });

    html += '</div>';

    resultsDiv.innerHTML = html;
  }
</script>

<style>
  .search-container {
    position: relative;
    max-width: 600px;
    margin: 0 auto;
  }

  #ai-search-input {
    width: 100%;
    padding: 12px 16px;
    font-size: 16px;
    border: 2px solid #e0e0e0;
    border-radius: 24px;
    outline: none;
    transition: border-color 0.2s;
  }

  #ai-search-input:focus {
    border-color: #4285f4;
  }

  #search-results {
    margin-top: 20px;
  }

  .ai-summary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
  }

  .ai-summary h3 {
    margin: 0 0 10px 0;
    font-size: 18px;
  }

  .search-result-item {
    padding: 16px;
    border-bottom: 1px solid #e0e0e0;
  }

  .search-result-item:last-child {
    border-bottom: none;
  }

  .search-result-item h4 {
    margin: 0 0 8px 0;
  }

  .search-result-item a {
    color: #1a73e8;
    text-decoration: none;
  }

  .search-result-item a:hover {
    text-decoration: underline;
  }

  .loading {
    text-align: center;
    padding: 20px;
    color: #666;
  }

  .error, .no-results {
    text-align: center;
    padding: 20px;
    color: #666;
  }
</style>
```

### ç¯å¢ƒå˜é‡é…ç½®

åœ¨ `.env` æ–‡ä»¶ä¸­æ·»åŠ ï¼š

```bash
PUBLIC_SEARCH_API_URL=https://asia-northeast1-your-project.cloudfunctions.net/vertex-ai-search
```

## é«˜çº§åŠŸèƒ½å®ç°

### 1. æœç´¢ç»“æœç¼“å­˜

ä¸ºäº†å‡å°‘APIè°ƒç”¨æˆæœ¬ï¼Œå®ç°å®¢æˆ·ç«¯ç¼“å­˜ï¼š

```javascript
// ç®€å•çš„å†…å­˜ç¼“å­˜
const searchCache = new Map();
const CACHE_TTL = 5 * 60 * 1000; // 5åˆ†é’Ÿ

async function performSearch(query) {
  const cacheKey = query.toLowerCase();
  const cached = searchCache.get(cacheKey);

  // æ£€æŸ¥ç¼“å­˜
  if (cached && Date.now() - cached.timestamp < CACHE_TTL) {
    displayResults(cached.data);
    return;
  }

  // æ‰§è¡Œæœç´¢
  const data = await fetchSearchResults(query);

  // ä¿å­˜åˆ°ç¼“å­˜
  searchCache.set(cacheKey, {
    data,
    timestamp: Date.now(),
  });

  displayResults(data);
}
```

### 2. æœç´¢åˆ†æè¿½è¸ª

é›†æˆGoogle Analyticsè¿½è¸ªæœç´¢è¡Œä¸ºï¼š

```javascript
function trackSearch(query, resultsCount) {
  // Google Analytics 4
  if (typeof gtag !== 'undefined') {
    gtag('event', 'search', {
      search_term: query,
      results_count: resultsCount,
    });
  }

  // æˆ–ä½¿ç”¨è‡ªå®šä¹‰API
  fetch('/api/track-search', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ query, resultsCount }),
  });
}
```

### 3. æœç´¢å»ºè®®ï¼ˆè‡ªåŠ¨å®Œæˆï¼‰

å®ç°æœç´¢å»ºè®®åŠŸèƒ½ï¼š

```javascript
// è·å–çƒ­é—¨æœç´¢å…³é”®è¯
const popularQueries = [
  'Vertex AI',
  'Cloud Functions',
  'Google Cloud',
  'AI Search',
];

function showSuggestions(inputValue) {
  const suggestions = popularQueries
    .filter(q => q.toLowerCase().includes(inputValue.toLowerCase()))
    .slice(0, 5);

  // æ˜¾ç¤ºå»ºè®®åˆ—è¡¨
  const suggestionsHTML = suggestions.map(s =>
    `<div class="suggestion" onclick="selectSuggestion('${s}')">${s}</div>`
  ).join('');

  document.getElementById('suggestions').innerHTML = suggestionsHTML;
}

function selectSuggestion(query) {
  searchInput.value = query;
  performSearch(query);
}
```

## æˆæœ¬ä¼˜åŒ–ç­–ç•¥

### Cloud Functionsé…ç½®ä¼˜åŒ–

æ ¹æ®å®é™…æµé‡è°ƒæ•´é…ç½®ï¼š

```bash
# ä½æµé‡ç½‘ç«™ï¼ˆä¸ªäººåšå®¢ï¼‰
MEMORY=128MB
MIN_INSTANCES=0      # å†·å¯åŠ¨å¯æ¥å—
MAX_INSTANCES=3      # é™åˆ¶æœ€å¤§æˆæœ¬

# ä¸­ç­‰æµé‡ç½‘ç«™
MEMORY=256MB
MIN_INSTANCES=1      # é¿å…å†·å¯åŠ¨
MAX_INSTANCES=10

# é«˜æµé‡ç½‘ç«™
MEMORY=512MB
MIN_INSTANCES=3      # ä¿è¯å“åº”é€Ÿåº¦
MAX_INSTANCES=50
```

### Vertex AI Searché…é¢ç®¡ç†

ç›‘æ§å’Œä¼˜åŒ–APIä½¿ç”¨ï¼š

1. **å¯ç”¨é…é¢å‘Šè­¦**ï¼š
   - GCP Console â†’ IAM & Admin â†’ Quotas
   - è®¾ç½®å‘Šè­¦é˜ˆå€¼ï¼ˆå¦‚80%ï¼‰

2. **å®æ–½é€Ÿç‡é™åˆ¶**ï¼š
   ```javascript
   // åœ¨Cloud Functionsä¸­æ·»åŠ 
   const rateLimit = new Map();

   function checkRateLimit(ip) {
     const now = Date.now();
     const requests = rateLimit.get(ip) || [];

     // æ¸…ç†è¿‡æœŸè®°å½•
     const recent = requests.filter(time => now - time < 60000);

     if (recent.length >= 10) { // æ¯åˆ†é’Ÿæœ€å¤š10æ¬¡
       return false;
     }

     recent.push(now);
     rateLimit.set(ip, recent);
     return true;
   }
   ```

3. **å®¢æˆ·ç«¯é˜²æŠ–**ï¼š
   - è¾“å…¥300msåæ‰å‘èµ·è¯·æ±‚
   - é¿å…æ¯æ¬¡æŒ‰é”®éƒ½è°ƒç”¨API

## ç›‘æ§ä¸è°ƒè¯•

### Cloud Functionsæ—¥å¿—æŸ¥çœ‹

```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿—
gcloud functions logs read vertex-ai-search \
  --region=asia-northeast1 \
  --limit=50 \
  --format="table(time, log)"

# ç­›é€‰é”™è¯¯æ—¥å¿—
gcloud functions logs read vertex-ai-search \
  --region=asia-northeast1 \
  --filter="severity>=ERROR"
```

### æ€§èƒ½ç›‘æ§ä»ªè¡¨æ¿

åœ¨GCP Consoleä¸­è®¾ç½®ï¼š

1. **Cloud Monitoring â†’ Dashboards**
2. åˆ›å»ºè‡ªå®šä¹‰ä»ªè¡¨æ¿
3. æ·»åŠ ä»¥ä¸‹æŒ‡æ ‡ï¼š
   - å‡½æ•°è°ƒç”¨æ¬¡æ•°
   - å¹³å‡å“åº”æ—¶é—´
   - é”™è¯¯ç‡
   - é…é¢ä½¿ç”¨ç‡

### æµ‹è¯•è„šæœ¬

åˆ›å»ºè‡ªåŠ¨åŒ–æµ‹è¯•ï¼š

```bash
#!/bin/bash
# test_search.sh

FUNCTION_URL="https://asia-northeast1-xxx.cloudfunctions.net/vertex-ai-search"

# æµ‹è¯•æŸ¥è¯¢åˆ—è¡¨
QUERIES=(
  "Vertex AI"
  "Cloud Functions"
  "äººå·¥æ™ºèƒ½"
)

for query in "${QUERIES[@]}"; do
  echo "Testing query: ${query}"

  response=$(curl -s -X POST "${FUNCTION_URL}" \
    -H "Content-Type: application/json" \
    -d "{\"query\": \"${query}\", \"pageSize\": 5}")

  results_count=$(echo "${response}" | jq -r '.totalResults')

  if [ "${results_count}" -gt 0 ]; then
    echo "âœ… Success: ${results_count} results"
  else
    echo "âŒ Failed: No results"
  fi

  echo "---"
done
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜è§£å†³

<strong>é—®é¢˜1ï¼šCORSé”™è¯¯</strong>

```
Access to fetch at '...' from origin '...' has been blocked by CORS policy
```

<strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š
- ç¡®è®¤ `ALLOWED_DOMAINS` ç¯å¢ƒå˜é‡åŒ…å«ä½ çš„åŸŸå
- æ£€æŸ¥åŸŸåæ ¼å¼ï¼ˆåŒ…å«åè®®ï¼š`https://example.com`ï¼‰
- é‡æ–°éƒ¨ç½²Cloud Functions

<strong>é—®é¢˜2ï¼šé…é¢è¶…é™</strong>

```json
{
  "error": "Search quota exceeded. Please try again later.",
  "retryAfter": 60
}
```

<strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š
- æ£€æŸ¥GCPé…é¢ä½¿ç”¨æƒ…å†µ
- å®æ–½è¯·æ±‚ç¼“å­˜
- è€ƒè™‘å‡çº§Vertex AI Searchè®¡åˆ’

<strong>é—®é¢˜3ï¼šéƒ¨ç½²å¤±è´¥</strong>

```
ERROR: (gcloud.functions.deploy) OperationError: code=7, message=Build failed
```

<strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š
```bash
# 1. æ£€æŸ¥package.jsonè¯­æ³•
npm install  # æœ¬åœ°æµ‹è¯•ä¾èµ–

# 2. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
gcloud functions logs read vertex-ai-search --limit=100

# 3. æ¸…ç†å¹¶é‡æ–°éƒ¨ç½²
rm -rf node_modules
./deploy.sh
```

### è°ƒè¯•æŠ€å·§

1. **æœ¬åœ°æµ‹è¯•Cloud Functions**ï¼š
   ```bash
   # å®‰è£…Functions Framework
   npm install @google-cloud/functions-framework

   # æœ¬åœ°è¿è¡Œ
   export PROJECT_ID=your-project-id
   export ENGINE_ID=your-engine-id
   npx functions-framework --target=search --port=8080

   # æµ‹è¯•è¯·æ±‚
   curl -X POST http://localhost:8080 \
     -H "Content-Type: application/json" \
     -d '{"query": "test", "pageSize": 5}'
   ```

2. **å¯ç”¨è¯¦ç»†æ—¥å¿—**ï¼š
   ```javascript
   // index.jsä¸­æ·»åŠ 
   console.log('Request received:', JSON.stringify(req.body));
   console.log('Search request:', JSON.stringify(request));
   console.log('Search response:', JSON.stringify(response));
   ```

## æ€»ç»“

æœ¬æ–‡è¯¦ç»†ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨Vertex AI Searchæ„å»ºæ™ºèƒ½ç«™å†…æœç´¢ç³»ç»Ÿï¼š

<strong>æ ¸å¿ƒè¦ç‚¹å›é¡¾</strong>ï¼š

1. **æ¶æ„è®¾è®¡**
   - Vertex AI Searchæä¾›AIé©±åŠ¨çš„æœç´¢èƒ½åŠ›
   - Cloud Functionsä½œä¸ºAPIä¸­é—´å±‚
   - å‰ç«¯é€šè¿‡HTTPè°ƒç”¨æœç´¢API

2. **è‡ªåŠ¨åŒ–éƒ¨ç½²**
   - Shellè„šæœ¬å®ç°ä¸€é”®éƒ¨ç½²
   - å¤šç¯å¢ƒé…ç½®ç®¡ç†
   - è‡ªåŠ¨ç”Ÿæˆæµ‹è¯•å·¥å…·

3. **å®‰å…¨ä¸æ€§èƒ½**
   - CORSåŸŸåç™½åå•
   - è¯·æ±‚é€Ÿç‡é™åˆ¶
   - å®¢æˆ·ç«¯ç¼“å­˜ä¼˜åŒ–

4. **æˆæœ¬æ§åˆ¶**
   - åˆç†çš„èµ„æºé…ç½®
   - é…é¢ç›‘æ§å‘Šè­¦
   - é™çº§ç­–ç•¥

### åç»­ä¼˜åŒ–æ–¹å‘

1. **å¢å¼ºåŠŸèƒ½**ï¼š
   - å®ç°æœç´¢å†å²è®°å½•
   - æ·»åŠ ä¸ªæ€§åŒ–æ¨è
   - æ”¯æŒå¤šè¯­è¨€æœç´¢
   - é›†æˆè¯­éŸ³æœç´¢

2. **æ€§èƒ½æå‡**ï¼š
   - ä½¿ç”¨CDNç¼“å­˜æœç´¢ç»“æœ
   - å®æ–½æœåŠ¡ç«¯æ¸²æŸ“ï¼ˆSSRï¼‰
   - ä¼˜åŒ–é¦–å±åŠ è½½é€Ÿåº¦

3. **åˆ†ææ·±åŒ–**ï¼š
   - æœç´¢å…³é”®è¯åˆ†æ
   - ç”¨æˆ·è¡Œä¸ºè¿½è¸ª
   - A/Bæµ‹è¯•ä¸åŒæœç´¢UI

4. **æ‰©å±•åœºæ™¯**ï¼š
   - æ•´åˆåˆ°ç§»åŠ¨åº”ç”¨
   - æ”¯æŒå›¾ç‰‡æœç´¢
   - æ¥å…¥ä¼ä¸šçŸ¥è¯†åº“

é€šè¿‡æœ¬æ–‡çš„å®è·µï¼Œä½ å·²ç»æŒæ¡äº†ä»é›¶åˆ°ä¸€æ„å»ºä¼ä¸šçº§AIæœç´¢ç³»ç»Ÿçš„å®Œæ•´æµç¨‹ã€‚Vertex AI Searchçš„å¼ºå¤§èƒ½åŠ›ï¼Œç»“åˆè‡ªåŠ¨åŒ–éƒ¨ç½²æµç¨‹ï¼Œèƒ½å¤Ÿå¤§å¹…æå‡ç”¨æˆ·æœç´¢ä½“éªŒï¼ŒåŒæ—¶é™ä½å¼€å‘å’Œç»´æŠ¤æˆæœ¬ã€‚

ç°åœ¨å°±å¼€å§‹ä¸ºä½ çš„ç½‘ç«™æ·»åŠ æ™ºèƒ½æœç´¢åŠŸèƒ½å§ï¼

## å‚è€ƒèµ„æº

- [Vertex AI Search å®˜æ–¹æ–‡æ¡£](https://cloud.google.com/generative-ai-app-builder/docs/enterprise-search-introduction)
- [Cloud Functions æ–‡æ¡£](https://cloud.google.com/functions/docs)
- [Discovery Engine API å‚è€ƒ](https://cloud.google.com/generative-ai-app-builder/docs/reference/rest)
- [GCP Shell è„šæœ¬æœ€ä½³å®è·µ](https://cloud.google.com/sdk/gcloud/reference)
