---
// Import the global.css file here so that it is included on
// all pages through the use of the <BaseHead /> component.
import '../styles/global.css';
import type { ImageMetadata } from 'astro';
import FallbackImage from '../assets/blog-placeholder-about.jpg';
import { SITE_TITLE, SITE_DESCRIPTION, AUTHOR, ORGANIZATION } from '../consts';

interface FAQItem {
	question: string;
	answer: string;
}

interface Props {
	title: string;
	description: string;
	image?: ImageMetadata;
	articleData?: {
		publishedTime: string;
		modifiedTime?: string;
		author: string;
		tags?: string[];
	};
	faqData?: FAQItem[];
	isHomePage?: boolean;
}

const canonicalURL = new URL(Astro.url.pathname, Astro.site);

const { title, description, image = FallbackImage, articleData, faqData, isHomePage = false } = Astro.props;

// 로컬호스트 체크 (GA 비활성화용)
const isLocalhost = Astro.url.hostname === 'localhost' || Astro.url.hostname === '127.0.0.1';

// Hreflang 태그 생성 로직
const pathname = Astro.url.pathname;
const langMatch = pathname.match(/^\/(ko|en|ja|zh)(\/|$)/);
const currentLang = langMatch ? langMatch[1] : null;

// 언어 코드를 제거한 경로 추출
let pathWithoutLang: string;
if (currentLang) {
	// /ko/blog/post-title -> /blog/post-title
	// /ko/ -> /
	// /ko -> /
	pathWithoutLang = pathname.replace(/^\/(ko|en|ja|zh)(\/|$)/, '/');
} else {
	// 루트 경로 또는 언어 코드가 없는 경로
	pathWithoutLang = pathname;
}

// 각 언어별 대체 URL 생성
const languages = ['ko', 'en', 'ja', 'zh'] as const;
const siteUrl = 'https://jangwook.net';

type HreflangTag = {
	lang: string;
	url: string;
};

const hreflangTags: HreflangTag[] = languages.map(lang => {
	// 루트 경로(/)는 각 언어 홈으로 매핑
	if (pathWithoutLang === '/' || pathWithoutLang === '') {
		return {
			lang,
			url: `${siteUrl}/${lang}/`
		};
	}

	// 블로그 포스트 경로 처리 (/blog/ko/..., /blog/en/...)
	// pathWithoutLang이 /blog/ko/... 형태라면 중간의 언어 코드도 변경해야 함
	let finalPath = pathWithoutLang;
	if (finalPath.startsWith('/blog/')) {
		// /blog/ko/slug -> /blog/{lang}/slug 로 변환
		finalPath = finalPath.replace(/^\/blog\/(ko|en|ja|zh)\//, `/blog/${lang}/`);
	}

	// 일반 경로는 언어 코드 + 경로
	return {
		lang,
		url: `${siteUrl}/${lang}${finalPath}`
	};
});

// x-default는 영어 버전으로 설정
const xDefaultUrl = pathWithoutLang === '/' || pathWithoutLang === ''
	? `${siteUrl}/en/`
	: `${siteUrl}/en${pathWithoutLang}`;

// WebSite Schema (모든 페이지)
const websiteSchema = {
	'@context': 'https://schema.org',
	'@type': 'WebSite',
	'name': SITE_TITLE,
	'description': SITE_DESCRIPTION,
	'url': Astro.site?.toString(),
};

// Person Schema (저자 정보 - E-E-A-T 향상)
const personSchema = {
	'@context': 'https://schema.org',
	'@type': 'Person',
	'@id': `${Astro.site}#author`,
	'name': AUTHOR.name,
	'url': AUTHOR.url,
	'image': AUTHOR.image,
	'jobTitle': AUTHOR.jobTitle,
	'description': AUTHOR.description,
	'sameAs': AUTHOR.sameAs,
	'knowsAbout': AUTHOR.knowsAbout
};

// Organization Schema (AEO: AI 검색엔진의 엔티티 인식 향상)
const organizationSchema = {
	'@context': 'https://schema.org',
	'@type': 'Organization',
	'@id': `${Astro.site}#organization`,
	'name': ORGANIZATION.name,
	'url': ORGANIZATION.url,
	'logo': {
		'@type': 'ImageObject',
		'url': ORGANIZATION.logo,
		'width': 512,
		'height': 512
	},
	'description': ORGANIZATION.description,
	'foundingDate': ORGANIZATION.foundingDate,
	'sameAs': ORGANIZATION.sameAs,
	'founder': {
		'@type': 'Person',
		'@id': `${Astro.site}#author`
	}
};

// FAQ Schema (AEO: Google AI Overview, ChatGPT 등에서 직접 답변 생성)
const faqSchema = faqData && faqData.length > 0 ? {
	'@context': 'https://schema.org',
	'@type': 'FAQPage',
	'mainEntity': faqData.map(item => ({
		'@type': 'Question',
		'name': item.question,
		'acceptedAnswer': {
			'@type': 'Answer',
			'text': item.answer
		}
	}))
} : null;

// Speakable Schema (음성검색 최적화: Google Assistant, Alexa 등)
const speakableSchema = articleData ? {
	'@context': 'https://schema.org',
	'@type': 'WebPage',
	'speakable': {
		'@type': 'SpeakableSpecification',
		'cssSelector': ['article h1', 'article h2', 'article p:first-of-type', '.article-summary']
	},
	'url': canonicalURL.toString()
} : null;

// Article Schema (블로그 포스트만) - AEO 최적화: author/publisher 연결
const articleSchema = articleData ? {
	'@context': 'https://schema.org',
	'@type': 'BlogPosting',
	'headline': title,
	'description': description,
	'image': new URL(image.src, Astro.url).toString(),
	'datePublished': articleData.publishedTime,
	'dateModified': articleData.modifiedTime || articleData.publishedTime,
	'author': {
		'@type': 'Person',
		'@id': `${Astro.site}#author`,
		'name': AUTHOR.name,
		'url': AUTHOR.url,
	},
	'publisher': {
		'@type': 'Organization',
		'@id': `${Astro.site}#organization`,
		'name': ORGANIZATION.name,
		'logo': {
			'@type': 'ImageObject',
			'url': ORGANIZATION.logo,
		},
	},
	'mainEntityOfPage': {
		'@type': 'WebPage',
		'@id': canonicalURL.toString(),
	},
	'inLanguage': currentLang || 'en',
	...(articleData.tags && { 'keywords': articleData.tags.join(', ') }),
} : null;
---

<!-- Theme initialization script (prevent flicker) -->
<script is:inline>
	// This script runs before the page renders to prevent flash of unstyled content
	(function() {
		const savedTheme = localStorage.getItem('theme');
		const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
		const theme = savedTheme || (prefersDark ? 'dark' : 'light');

		if (theme === 'dark') {
			document.documentElement.classList.add('dark');
		}
	})();
</script>

<!-- Global Metadata -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
<link rel="sitemap" href="/sitemap-index.xml" />

<!-- RSS Feeds (language-specific and global) -->
<link
	rel="alternate"
	type="application/rss+xml"
	title={`${SITE_TITLE} - All Languages`}
	href={new URL('rss.xml', Astro.site)}
/>
<link
	rel="alternate"
	type="application/rss+xml"
	title={`${SITE_TITLE} - 한국어`}
	href={new URL('rss-ko.xml', Astro.site)}
	hreflang="ko"
/>
<link
	rel="alternate"
	type="application/rss+xml"
	title={`${SITE_TITLE} - English`}
	href={new URL('rss-en.xml', Astro.site)}
	hreflang="en"
/>
<link
	rel="alternate"
	type="application/rss+xml"
	title={`${SITE_TITLE} - 日本語`}
	href={new URL('rss-ja.xml', Astro.site)}
	hreflang="ja"
/>

<meta name="generator" content={Astro.generator} />

<!-- Google AdSense -->
<meta name="google-adsense-account" content="ca-pub-7556938384772610">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7556938384772610"
     crossorigin="anonymous"></script>

<!-- Google Fonts Optimization (preconnect + async load) -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<!-- 필수 웨이트만 로드: Inter(400,600,700), Noto Sans KR(400,700), Noto Sans JP(400,700), JetBrains Mono(400,600) -->
<link
	href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+KR:wght@400;700&family=Noto+Sans+JP:wght@400;700&family=JetBrains+Mono:wght@400;600&display=swap"
	rel="stylesheet"
	media="print"
	onload="this.media='all'"
/>
<noscript>
	<link
		href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+KR:wght@400;700&family=Noto+Sans+JP:wght@400;700&family=JetBrains+Mono:wght@400;600&display=swap"
		rel="stylesheet"
	/>
</noscript>

<!-- Font preloads (local fonts) -->
<link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin />
<link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin />

<!-- Canonical URL -->
<link rel="canonical" href={canonicalURL} />

<!-- Hreflang Tags for Multilingual SEO -->
{hreflangTags.map(({ lang, url }) => (
	<link rel="alternate" hreflang={lang} href={url} />
))}
<link rel="alternate" hreflang="x-default" href={xDefaultUrl} />

<!-- Primary Meta Tags -->
<title>{title}</title>
<meta name="title" content={title} />
<meta name="description" content={description} />

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website" />
<meta property="og:url" content={Astro.url} />
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:image" content={new URL(image.src, Astro.url)} />

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:url" content={Astro.url} />
<meta property="twitter:title" content={title} />
<meta property="twitter:description" content={description} />
<meta property="twitter:image" content={new URL(image.src, Astro.url)} />

<!-- Schema.org Structured Data (AEO Optimized) -->
<script type="application/ld+json" set:html={JSON.stringify(websiteSchema)} />
<script type="application/ld+json" set:html={JSON.stringify(personSchema)} />
<script type="application/ld+json" set:html={JSON.stringify(organizationSchema)} />
{articleSchema && <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />}
{faqSchema && <script type="application/ld+json" set:html={JSON.stringify(faqSchema)} />}
{speakableSchema && <script type="application/ld+json" set:html={JSON.stringify(speakableSchema)} />}

<!-- Google Analytics (프로덕션 환경에서만 로드) -->
{!isLocalhost && (
	<>
		<script async src="https://www.googletagmanager.com/gtag/js?id=G-PWXG8FFDHW"></script>
		<script is:inline>
		  window.dataLayer = window.dataLayer || [];
		  function gtag(){dataLayer.push(arguments);}
		  gtag('js', new Date());

		  gtag('config', 'G-PWXG8FFDHW');
		</script>

		<!-- External Link Click Tracking -->
		<script is:inline>
	document.addEventListener('DOMContentLoaded', () => {
		console.log('[GA Debug] External link tracking initialized');

		// Track all external link clicks
		document.addEventListener('click', (event) => {
			const target = event.target;
			const link = target.closest('a');

			if (link && link.href) {
				const currentHost = window.location.hostname;
				const linkUrl = new URL(link.href, window.location.href);

				console.log('[GA Debug] Link clicked:', {
					href: link.href,
					currentHost,
					linkHost: linkUrl.hostname,
					isExternal: linkUrl.hostname !== currentHost,
					isSocialLink: link.classList.contains('social-link')
				});

				// Check if link is external (different domain)
				// Exclude social links (already tracked separately)
				if (linkUrl.hostname !== currentHost &&
					!link.classList.contains('social-link')) {
					console.log('[GA Debug] External link detected');

					// Send GA4 event
					if (typeof gtag !== 'undefined') {
						const eventData = {
							'link_url': link.href,
							'link_domain': linkUrl.hostname,
							'link_text': link.textContent?.trim() || '',
							'page_location': window.location.href,
							'event_category': 'engagement',
							'event_label': 'external_link'
						};
						console.log('[GA Debug] Sending external_link_click event:', eventData);
						gtag('event', 'external_link_click', eventData);
						console.log('[GA Debug] Event sent successfully');
					} else {
						console.warn('[GA Debug] gtag is not defined');
					}
				}
			}
		});
	});
		</script>

		<!-- Core Web Vitals Tracking -->
		<script>
	// Import and track Core Web Vitals
	import { onCLS, onLCP, onFCP, onTTFB, onINP, type Metric } from 'web-vitals';

	// Declare gtag function type
	declare function gtag(
		command: 'event',
		eventName: string,
		eventParams: Record<string, string | number | boolean>
	): void;

	function sendToGoogleAnalytics(metric: Metric): void {
		const { name, delta, value, id, rating } = metric;

		// Send to Google Analytics
		if (typeof gtag !== 'undefined') {
			gtag('event', name, {
				event_category: 'Web Vitals',
				event_label: id,
				value: Math.round(name === 'CLS' ? delta * 1000 : delta),
				metric_value: value,
				metric_rating: rating,
				non_interaction: true,
			});
		}

		// Log to console in development
		if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
			console.log(`[Web Vitals] ${name}:`, {
				value: Math.round(name === 'CLS' ? value * 1000 : value) / (name === 'CLS' ? 1000 : 1),
				rating: rating,
				id: id
			});
		}
	}

	// Track all Core Web Vitals
	onCLS(sendToGoogleAnalytics);  // Cumulative Layout Shift
	onLCP(sendToGoogleAnalytics);  // Largest Contentful Paint
	onFCP(sendToGoogleAnalytics);  // First Contentful Paint
	onTTFB(sendToGoogleAnalytics); // Time to First Byte
	onINP(sendToGoogleAnalytics);  // Interaction to Next Paint (replaces deprecated FID)
		</script>

	</>
)}

<!-- 로컬호스트 환경 디버그 메시지 -->
{isLocalhost && (
	<script is:inline>
		console.log('[GA] Google Analytics is disabled in localhost environment');
	</script>
)}
